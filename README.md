# LRT Test - Telegram Bot for Video Analytics

Telegram-бот для аналитики по видео на основе задач на естественном языке. Бот принимает запросы на русском языке, преобразует их в SQL-запросы с помощью LLM (OpenAI) и возвращает числовые результаты.

## Архитектура

```
Пользователь → Telegram Bot (aiogram) → OpenAI API → SQL запрос → PostgreSQL → Числовой ответ
```

### Компоненты

- **Telegram Bot** (aiogram 3.x) - обработка сообщений от пользователей
- **OpenAI API** - преобразование естественного языка в SQL запросы
- **PostgreSQL** - хранение данных о видео и их статистике
- **Asyncpg** - асинхронный драйвер для работы с PostgreSQL

## Структура проекта

```
LRT_test/
├── bot/                    # Код Telegram бота
│   ├── main.py            # Точка входа
│   ├── handlers.py        # Обработчики сообщений
│   ├── llm_service.py     # Интеграция с OpenAI
│   ├── query_builder.py   # Выполнение SQL запросов
│   └── database.py        # Подключение к БД
├── database/
│   ├── migrations/
│   │   └── 001_initial.sql # Схема БД
│   └── load_data.py       # Скрипт загрузки данных
├── docker-compose.yml     # PostgreSQL контейнер
├── pyproject.toml         # Poetry зависимости
└── README.md
```

## Установка и запуск

### Требования

- Python 3.10+
- Poetry
- Docker и Docker Compose

### Шаги установки

1. **Клонируйте репозиторий:**
```bash
git clone https://github.com/Skvorcmen/RLT_test.git
cd LRT_test
```

2. **Установите зависимости:**
```bash
poetry install
```

3. **Настройте переменные окружения:**
```bash
cp .env.example .env
```

Отредактируйте `.env` и укажите:
- `TELEGRAM_BOT_TOKEN` - токен вашего Telegram бота (получите у [@BotFather](https://t.me/BotFather))
- `OPENAI_API_KEY` - API ключ OpenAI
- `DATABASE_URL` - URL базы данных (по умолчанию используется из docker-compose)

4. **Запустите PostgreSQL:**
```bash
docker-compose up -d
```

5. **Загрузите данные в базу:**
```bash
poetry run python database/load_data.py
```

Скрипт автоматически скачает JSON файл с Google Drive и загрузит данные в базу.

6. **Запустите бота:**
```bash
poetry run python bot/main.py
```

## Настройка токена Telegram бота

1. Откройте [@BotFather](https://t.me/BotFather) в Telegram
2. Отправьте команду `/newbot`
3. Следуйте инструкциям для создания бота
4. Скопируйте полученный токен в файл `.env` в переменную `TELEGRAM_BOT_TOKEN`

## Описание архитектуры

### Преобразование естественного языка в SQL

Бот использует OpenAI API для преобразования запросов на русском языке в SQL запросы. Процесс включает:

1. **Промпт с описанием схемы БД** - детальное описание таблиц `videos` и `video_snapshots` с примерами
2. **Обработка дат** - преобразование русских форматов дат ("28 ноября 2025") в SQL формат
3. **Валидация SQL** - проверка безопасности (только SELECT запросы, запрет опасных операций)
4. **Выполнение запроса** - асинхронное выполнение через asyncpg
5. **Извлечение результата** - возврат первого числового значения из результата

### Промпт для LLM

Промпт включает:
- Полное описание схемы базы данных (таблицы, поля, типы)
- Примеры запросов на русском и соответствующие SQL
- Правила обработки дат в русском формате
- Инструкции по агрегации (COUNT, SUM, и т.д.)
- Требование возвращать только SQL SELECT запрос

### Примеры запросов

- "Сколько всего видео есть в системе?"
- "Сколько видео у креатора с id 123 вышло с 1 ноября 2025 по 5 ноября 2025 включительно?"
- "Сколько видео набрало больше 100000 просмотров за всё время?"
- "На сколько просмотров в сумме выросли все видео 28 ноября 2025?"
- "Сколько разных видео получали новые просмотры 27 ноября 2025?"

## База данных

### Таблица `videos`

Итоговая статистика по каждому видео:
- `id` - идентификатор видео
- `creator_id` - идентификатор креатора
- `video_created_at` - дата публикации
- `views_count`, `likes_count`, `comments_count`, `reports_count` - финальные значения
- `created_at`, `updated_at` - служебные поля

### Таблица `video_snapshots`

Почасовые замеры статистики:
- `id` - идентификатор снапшота
- `video_id` - ссылка на видео
- `views_count`, `likes_count`, `comments_count`, `reports_count` - текущие значения
- `delta_views_count`, `delta_likes_count`, `delta_comments_count`, `delta_reports_count` - приращения
- `created_at` - время замера

## Технические детали

- Все операции асинхронные (async/await)
- Использование connection pooling для БД
- Обработка ошибок на всех уровнях
- Логирование для отладки
- Валидация SQL запросов на безопасность

## Проверка бота

После развертывания бота используйте служебного бота [@rlt_test_checker_bot](https://t.me/rlt_test_checker_bot) для автоматической проверки:

```
/check @yourbotnickname https://github.com/Skvorcmen/RLT_test
```

## Лицензия

Проект создан в рамках тестового задания.
